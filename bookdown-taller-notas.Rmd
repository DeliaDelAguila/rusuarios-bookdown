---
title: "Taller de bookdown"
subtitle: "Reunión de usuarios de R (ITAM, 2018)"
author: "Felipe González"
date: "2/13/2018"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Bookdown

- [Bookdown](https://cran.rstudio.com/web/packages/bookdown/index.html) es un paquete de R que hace más fácil escribir libros, notas de clase, o reportes técnicos largos.

- Bookdown está construido encima de [rmarkdown](http://rmarkdown.rstudio.com). Añade características
como referencias, referencias cruzadas para ecuaciones, figuras, tablas, etc. que son útiles para documentos más largos que reportes simples.

- Sus ventajas son la conveniencia de escribir el contenido en markdown (que es fácil de usar), mútiples tipos de salida (HTML, PDF, Word, etc), gráficas y tablas interactivas.

## Referencias importantes

El libro de bookdown de Yihui Xie acerca de bookdown es la referencia
más importante <https://bookdown.org/yihui/bookdown/>. La mayor parte
del contenido de esta plática está en esta referencia.

Esta referencia también útil (aunque algunas cosas han cambiado
desde su publicación): <https://juliasilge.com/blog/beginners-guide-to-travis/>

Ver la configuración de otros paquetes de R en github también ayuda (por ejemplo <https://github.com/juliasilge/janeaustenr/>)

## Caso: preparar y distribuir notas de clase

Dificultades:

- Mantenimiento de notas 
- Separación de notas de teoría, ejemplos, aplicaciones
- Acceso fácil a notas, resultados y código
- Reproducibilidad

<!---
- Mantener al día las notas (corregir typos ;) por ejemplo) es trabajoso, y notificar de los cambios no muy claro.
- Tener partes separadas (notas de teoría, ejemplos, aplicaciones) hace más dificíl estudiar las notas y conectar los conceptos (?)
- La idea es que los estudiantes puedan acceder al código y notas completas de manera fácil, y puedan derivar de ahí su trabajo.
- Reproducibilidad: En muchos casos, reproducir los resultados de código o ejemplos puede ser difícil para los estudiantes. Unas notas con todo el material junto les permite ver al menos qué resultados deberían obtener.
--->

## Temas 

- Cómo hacer un reporte o libro con bookdown y compartirlo de manera fácil
- Cómo mantener y compartir el código de las notas (Github, Github pages)
- Cómo automatizar la construcción, pruebas y distribución de notas (TravisCI)


<!--- ver primero un demo general, y luego parte por parte
enseñar aprendizaje máquina, y luego interactivos del
curso de métodos analíticos --->

<!--- Ahora explicar los básicos de markdown --->
<!-- hacer uno rápido -->
<!-- de los primeros, hacer a mano en línea de comandos 
bookdown::render_book("index.Rmd", "bookdown::gitbook")

Agregar:
site: bookdown::bookdown_site
output:
  bookdown::gitbook: default

y también:

  bookdown::gitbook: 
    config:
      sharing: no  
  
-->

## _bookdown.yaml

Aquí podemos configurar más aspectos en este archivo:

```
before_chapter_script: ["script1.R", "script2.R"]
after_chapter_script: "script3.R"
language:
  label:
    fig: "Figura "
    tab: "Tabla "
  ui:
    chapter_name: "Clase "
new_session: yes
```

## Referencias cruzadas

- Para matemáticas: (\#eq:label) para etiquetar  y \@ref(eq:label) para referir

- Para tablas: la manera más simple es usar knitr::kable, si el chunk se llama mi-tabla, entonces la referencia es \@ref(tab:mi-tabla)

-  Para figuras: si usamos la opción fig.cap = "Descripción" en el chunk con nombre label, nos referimos con  \@ref(fig:label). Usar también fig.align = "center" es útil

- Para secciones: usar también \@ref(label) donde label es el identificador de la sección (se puede usar {#label} después del
nombre de la sección para escoger la etiqueta).

- Interactivos se pueden etiquetar como gráficas.

## Referencias

Usar un archivo book.bib (referencias tipo bibtex),
añadir al yaml del primer archivo 
```
bibliography: ["book.bib"]
link-citations: true
```
y referir con [@label]

## Algo de automatización

- Hacer scripts build.sh y deploy.sh, por ejemplo, para construir
las notas y subirlas a nuestro sitio. 

- Por ejemplo, si usamos netlify, existen herramientas de línea
de comandos para actualizar nuestro sitio <https://www.netlify.com/docs/cli/>

## Compartir código

Una manera es compartir en ftp, dropbox, etc. todos los archivos. Usar Github es una mejor solución por varias razones. En nuestro caso:

- Los estudiantes pueden ver cambios en las notas (nuevas secciones, nuevas instrucciones, correcciones, etc.)
- Podemos ligar a otros servicios que se encarguen de actualizar automáticamente las notas cuando subimos cambios al repositorio de código.
- En algunos casos, los estudiantes contribuyen correcciones a las notas!

## Una manera de hacer esto

(Se requiere tener instalado git, una cuenta de github, y configuración para poder hacer cambios a nuestros repositorios)

- Hacer un nuevo repositorio en Github. Copiar la liga del repositorio
- Nuevo proyecto en Rstudio -> Version control. Copiar en repository
URL la liga del repositorio.
- Agregar archivos, hacer commit y push al nuevo repositorio. 

Si trabajamos manualmente, podemos hacer cambios al repositorio, compilar localmente las notas y subir el contenido de _book a donde sea que estemos compartiendo.

## Travis CI y Github pages

Otra manera de distribuir notas y código, y automatizar la construcción de las notas es utilizar algún servicio 
de integración continua como TravisCI.

- El soporte para R en TravisCI está diseñado principalmente
para desarrollo y prueba de paquetes, pero se puede usar también
para compilar y distribuir bookdown.

- Como en los paquetes agregamos un archivo con DESCRIPTION

## Archivos .travis.yml, build y deploy

Crear instrucciones para que travis pueda construir nuestro
libro y ponerlo en el lugar correcto.


## Configuración gh-pages

- Crear una rama del repositorio que se llame gh-pages, en blanco:

```
git checkout --orphan gh-pages
git rm -rf .
touch .nojekyll
git add .nojekyll
git commit -m "Commit inicial"
git push origin gh-pages
```

## Token de acceso en Github

- Para que Travis pueda subir el libro compilado, necesitamos un
access token de Github (En Github, Settings->Developer settings -> Personal access token). Generar el token y copiarlo

- En Travis, seleccionar activar nuestro repositorio. En settings
agregar la variable GITHUB_PAT con el token que obtuvimos.


